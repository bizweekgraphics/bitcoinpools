<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" />
  <link href="apple-touch-icon-precomposed.png" rel="apple-touch-icon" type="image/png" />

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/h5bp.css">
  <link rel="stylesheet" href="css/bbw.css">
  <script src="js/vendor/modernizr-2.6.2.min.js"></script>
</head>

<!--
Body classes:
.iframed    // no interface wrapping, no margins
.dark_layout  // like bbw video site
.half      // half-width of standard article (315px)
.full      // full-width of standard article (630px)
.wide      // wide interactive feature layout (970px)

Fonts:
font-family:BloombergLBold    // corporate wordmark logotype
font-family:BWHaasHead
font-family:BWHaasHead75Bold
font-family:BWHaasRegular
-->

<body class="wide">

  <div id="stacked-area"></div>

  <div id="small-multiples"></div>

  <div class="clearfix"></div>
  <div class="data-credit">Graphic by Bloomberg Businessweek. Data: <a href="http://organofcorti.blogspot.com/">Organ of Corti</a> (<a href="data/blocksolves-weekly-with-daily.csv">csv</a>)</div>
  <div class="data-caveats">
    <p><strong>Caveats and methodology:</strong> Data is derived from claims made by miners, either on their websites or in coinbase signatures, and known addresses. Due to the anonymous nature of the Bitcoin network, mining (in the form of block solves) is only identifiable if declared, and even then is not verifiable. Notably, Slush's pool was the first in operation (in December 2010), but data for it only became available in January 2012.</p>
    <p>Data is weekly except for the three weeks when DeepBit, BTC Guild, and GHash.IO peaked, during which daily data is shown; thus, the jagged spots indicate higher-resolution data, not necessarily higher intrinsic volatility.</p>
  </div>

  <script src="js/vendor/d3.min.js"></script>
  <script src="js/vendor/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
  <script src="js/plugins.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/main.js"></script>

  <script>

    // breakout setup

    var poolChart = timeSeriesChart()
        .dataAccessor("values")
        .margin({top: 10, right: 10, bottom: 20, left: 35})
        .x(function(d) { return d.date; })
        .y(function(d) { return +d.y; })
        .yDomain(function(d) {
            if(d.name == "DeepBit" || d.name == "BTC Guild" || d.name == "GHash.IO") {
              return [0,.5];
            } else {
              return [0,.25];
            }
          })
        .width(315)
        .height(function(d) {
            if(d.name == "DeepBit" || d.name == "BTC Guild" || d.name == "GHash.IO") {
              return 120;
            } else {
              return 75;
            }
          });

    // stacked area chart setup

    var margin = {top: 20, right: 35, bottom: 30, left: 35},
        width = 970 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%m/%d/%y").parse,
        formatDateLong = d3.time.format("%b. %d, %Y"),
        formatPrice = d3.format("$.2r"),
        formatPercent = d3.format(".0%");

    var x = d3.time.scale()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.category20();

    var xAxis = d3.svg.axis()
        .scale(x)
        .tickSize(6,0)
        .ticks(3)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickValues([0,.25,.5,.75,1])
        .tickFormat(formatPercent);

    // redline
    var gridlines = d3.svg.axis()
        .scale(y)
        .orient("right")
        .tickSize(width,0)
        .tickValues([0.5])
        .tickFormat("");

    var area = d3.svg.area()
        .x(function(d) { return x(d.date); })
        .y0(function(d) { return y(d.y0); })
        .y1(function(d) { return y(d.y0 + d.y); });

    var stack = d3.layout.stack()
        .values(function(d) { return d.values; });

    var svg = d3.select("#stacked-area").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .classed("chartarea", true)
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // appending diagonal hatch pattern
    // cf. http://stackoverflow.com/a/17777121/120290
    svg
      .append('defs')
      .append('pattern')
        .attr('id', 'diagonalHatch')
        .attr('patternUnits', 'userSpaceOnUse')
        .attr('width', 4)
        .attr('height', 4)
      .append('path')
        .attr('d', 'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2')
        .attr('stroke', '#000000')
        .attr('stroke-width', 0.5);

    d3.csv("data/blocksolves-weekly-with-daily.csv", function(error, data) {
      d3.csv("data/coindesk-bpi-USD-close.csv", function(error, priceData) {

        var pools = _.uniq(_.pluck(data,'pool'));
        var dates = _.uniq(_.pluck(data,'date'));

        var poolblocks = pools.map(function(p) {
          var pool = {
            name: p,
            values: dates.map(function(d) {
              var datum = _.where(data,{pool:p,date:d});
              return { date: parseDate(d), y: datum.length>0 ? +datum[0].percentage/100 : 0 };
            })
          };
          pool.max = d3.max(pool.values, function(d) { return d.y; });
          return pool;
        });
        poolblocks = _.sortBy(poolblocks, function(d) {
          if(d.name=="Unknown") return 1;
          if(d.name=="DeepBit") return -4;
          if(d.name=="BTC Guild") return -3;
          if(d.name=="GHash.IO") return -2;
          //this will be between -1 and 0
          return -d.max;
        })
        var poolstack = stack(poolblocks);
        console.log(poolstack);

        x.domain(d3.extent(dates.map(function(d) { return parseDate(d); })));

        var pool = svg.selectAll(".pool")
            .data(poolstack)
          .enter().append("g")
            .attr("class", "pool")
            .attr("data-pool", function(d) { return d.name; });

        pool.append("path")
            .attr("class", "area")
            .attr("d", function(d) { return area(d.values); });

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        svg.append("g")
            .attr("class", "gridlines")
            .call(gridlines);

        var tooltip = d3.select("#stacked-area")
          .append("div")
          .classed("tooltip", true)
          .style("display", "none");

        // breakouts

        var smallMultiplesEnter = d3.select("#small-multiples").selectAll("div.breakout")
            .data(poolstack)
          .enter()
            .append("div")
            .classed("small-multiple", true)
            .attr("data-pool", function(d) { return d.name; });

        smallMultiplesEnter
            .append("h3").text(function(d) { return d.name; });

        smallMultiplesEnter
            .call(poolChart);

        // prices

        var selectedPriceData = [];
        // get prices at extremes of pool data
        selectedPriceData.push(_.findWhere(priceData, {"date": dates[0]}));
        selectedPriceData.push(_.findWhere(priceData, {"date": dates[dates.length-1]}));
        // get dates of prices for every power-of-ten milestone
        for(var i = 1; i < 4; i++) {
          var threshold = Math.pow(10,i);
          selectedPriceData.push(_.find(priceData, function(d) { return d.price >= threshold; }));
        }

        var getPrice = function(d) {
          // converting date object back to non-zero-padded string as found in the csv
          var date = d3.time.format("%-m/%-d/%y")(d);
          return formatPrice(_.findWhere(priceData, {"date": date}).price);
        }

        var priceline = d3.svg.axis()
            .scale(x)
            .tickSize(6,0)
            .orient("top")
            .tickValues(_.pluck(selectedPriceData, "date").map(function(d) { return parseDate(d); }))
            .tickFormat(getPrice);
        svg.append("g")
            .attr("class", "priceline axis")
            .call(priceline);

        // rollovers

        d3.selectAll(".pool").on("mousemove", function(d, i) {

          var mouseDate = x.invert(d3.mouse(d3.select("#stacked-area")[0][0])[0]-margin.left);

          // show dateline marginal (x axis bottom, scrubber)
          xAxis.tickValues([mouseDate]).tickSize(height+6,0).tickFormat(formatDateLong);
          d3.select(".x.axis").attr("transform", "translate(0,0)").call(xAxis);

          // show priceline marginal (x axis top, scrubber)
          priceline.tickValues([mouseDate]);
          d3.select(".priceline").call(priceline);

          // show tooltip over mouse
          tooltip
            .style("left", d3.mouse(d3.select("#stacked-area")[0][0])[0]+"px")
            .style("top", d3.mouse(d3.select("#stacked-area")[0][0])[1]+"px")
            .style("display", "block")
            .html("<b>"+d.name+"</b><br/>Max share: "+formatPercent(d.max));

          // highlight corresponding small multiple
          d3.selectAll("#small-multiples .small-multiple").classed("active", false);
          d3.select('#small-multiples [data-pool="'+d.name+'"]').classed("active", true);

        });

        // clear hover info and restore normal axes on mouseout
        d3.select(".chartarea").on("mouseout", function() {

          // revert to normal dateline (x axis bottom)
          xAxis.tickValues(null).tickSize(6,0).tickFormat(null);
          d3.select(".x.axis").attr("transform", "translate(0," + height + ")").call(xAxis);

          // revert to normal priceline (x axis top)
          priceline.tickValues(_.pluck(selectedPriceData, "date").map(function(d) { return parseDate(d); }));
          d3.select(".priceline").call(priceline);

          d3.selectAll("#small-multiples .small-multiple").classed("active", false);
          tooltip.style("display", "none");
          d3.selectAll("#stacked-area .x.axis text").style("opacity", 1);
        })


      });

    });

  </script>

</body>
</html>
